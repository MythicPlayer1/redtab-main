import { FC, PropsWithChildren, useEffect } from "react";
import { ActivityLayout } from "./ActivityLayout";
import { IconBack } from "./IconBack";
import { useTranslation } from "react-i18next";
import { useLocation, useNavigate } from "react-router-dom";
import BottomTabItem from "./Tabs/BottomTabItem";
import React from "react";
import { useDimensionsStore } from "../store/dimensions";
import {
  useOutletBusinessType,
} from "../store/business-type-store/use-outlet-business-type-store";

export interface TabLayoutProps {
  title?: React.ReactNode;
  onAction?: () => void;
  noMyfooter?: boolean;
  noMy?: boolean;
  errorStatus?: boolean;
}

export const TabLayout: FC<PropsWithChildren<TabLayoutProps>> = (props) => {
  const accessToken = localStorage?.getItem("token-storage");
  const accessTokenExist = JSON?.parse(accessToken as string)?.state?.accessToken;
  const tabSelected = localStorage.getItem("tabSelected");
  const { t } = useTranslation("TabLayout");
  const { businessTypeName } = useOutletBusinessType();
  const location = useLocation();
  const navigate = useNavigate();

  const showBackIcon =
    location.pathname !== "/products" &&
    location.pathname !== "/finance" &&
    location.pathname !== "/merchant-profile" &&
    location.pathname !== "/pos-main" &&
    location.pathname !== "/pos-calculator" &&
    location.pathname !== "/pos-send-receipt" &&
    location.pathname !== "/profile" &&
    location.pathname !== "/home" &&
    location.pathname !== "/auth-redirect" &&
    location.pathname !== "/notification";

  const footerRef = React.useRef<HTMLDivElement>(null);
  const { setHeight } = useDimensionsStore();

  useEffect(() => {
    if (footerRef.current) {
      setHeight(footerRef.current.clientHeight);
      console.log(footerRef.current.clientHeight);
    }
  }, []);

  const handleNavigation = (path: string, name: string) => {
    if (accessTokenExist) {
      navigate(path);
    } else {
      navigate("/auth-redirect");
    }
    localStorage.setItem("tabSelected", name);
  };

  const handleHome = () => {
    navigate("/home");
    localStorage.setItem("tabSelected", "");
  };

  return (
    <ActivityLayout
      arrowBack={
        showBackIcon && (
          <div className="py-4 px-4 min-h-20 flex items-center justify-between">
            <button onClick={() => props.onAction?.()}>
              <IconBack />
            </button>
            <div className="font-semibold">{props.title}</div>
            <div></div>
          </div>
        )
      }
      noMyFooter={props?.noMyfooter}
      noMy={props?.noMy}
      footer={
        <div className="flex w-full fixed bottom-0 z-50  border-t-[1px] border-[#EAECF0] bg-[#fff] " ref={footerRef}>
          <BottomTabItem
            onClick={handleHome}
            active={location.pathname === "/home"}
            icon={
              <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  fillRule="evenodd"
                  clipRule="evenodd"
                  d="M9.18541 1.85068C9.0649 1.81153 8.93509 1.81153 8.81459 1.85068C8.80134 1.85499 8.74524 1.87469 8.59649 2.00097C8.4397 2.13407 8.24685 2.32594 7.93933 2.63345L2.57365 7.99914C2.19746 8.37534 2.11717 8.4638 2.06209 8.55369C2.00178 8.6521 1.95734 8.7594 1.93039 8.87164C1.90578 8.97415 1.9 9.09347 1.9 9.62549V14.6C1.9 15.0349 1.9007 15.3069 1.91744 15.5119C1.93333 15.7064 1.95907 15.76 1.96539 15.7724C2.02292 15.8853 2.11471 15.9771 2.2276 16.0346C2.24001 16.0409 2.29362 16.0667 2.48809 16.0825C2.69307 16.0993 2.96511 16.1 3.4 16.1H6.1V12.9C6.1 11.2984 7.39837 9.99999 9 9.99999C10.6016 9.99999 11.9 11.2984 11.9 12.9V16.1H14.6C15.0349 16.1 15.3069 16.0993 15.5119 16.0825C15.7064 16.0667 15.76 16.0409 15.7724 16.0346C15.8853 15.9771 15.9771 15.8853 16.0346 15.7724C16.0409 15.76 16.0667 15.7064 16.0825 15.5119C16.0993 15.3069 16.1 15.0349 16.1 14.6V9.62549C16.1 9.09347 16.0942 8.97415 16.0696 8.87165C16.0427 8.7594 15.9982 8.6521 15.9379 8.55369C15.8828 8.4638 15.8025 8.37534 15.4263 7.99914L10.0607 2.63345C9.75314 2.32594 9.56029 2.13407 9.4035 2.00097C9.25476 1.87469 9.19866 1.85499 9.18541 1.85068ZM8.25835 0.138781C8.74038 -0.0178383 9.25961 -0.0178384 9.74164 0.138781C10.0709 0.245759 10.3345 0.430202 10.5684 0.628759C10.7881 0.815221 11.0331 1.06024 11.3099 1.3371L16.6991 6.72635C16.718 6.74526 16.7368 6.76396 16.7553 6.78248C17.0463 7.07302 17.2919 7.3182 17.4727 7.61319C17.6317 7.87266 17.7488 8.15554 17.8199 8.45144C17.9006 8.78784 17.9004 9.13486 17.9 9.54605C17.9 9.57227 17.9 9.59874 17.9 9.62549V14.6333C17.9 15.0248 17.9 15.3713 17.8766 15.6585C17.8516 15.9643 17.7956 16.2811 17.6384 16.5896C17.4083 17.0412 17.0412 17.4083 16.5896 17.6384C16.2811 17.7956 15.9643 17.8516 15.6585 17.8766C15.3713 17.9 15.0248 17.9 14.6333 17.9H11.1887C10.5874 17.9 10.1 17.4126 10.1 16.8113V12.9C10.1 12.2925 9.60751 11.8 9 11.8C8.39248 11.8 7.9 12.2925 7.9 12.9V16.8113C7.9 17.4126 7.41258 17.9 6.81134 17.9H3.36666C2.97515 17.9 2.62866 17.9 2.34151 17.8766C2.03573 17.8516 1.71887 17.7956 1.41042 17.6384C0.958829 17.4083 0.591676 17.0412 0.361581 16.5896C0.204415 16.2811 0.148405 15.9643 0.123421 15.6585C0.0999597 15.3713 0.0999763 15.0248 0.0999949 14.6333L0.099996 9.62549C0.099996 9.59874 0.0999752 9.57227 0.0999547 9.54606C0.099632 9.13486 0.0993598 8.78785 0.180123 8.45144C0.251163 8.15554 0.368336 7.87266 0.527339 7.61319C0.708104 7.31821 0.953676 7.07302 1.24467 6.78249C1.26321 6.76397 1.28194 6.74526 1.30086 6.72635L6.69011 1.33708C6.96694 1.06024 7.21193 0.815218 7.43157 0.628759C7.66546 0.430202 7.92911 0.245759 8.25835 0.138781Z"
                  fill="currentColor"
                />
              </svg>
            }
          >
            {t("Market", { defaultValue: "Market" })}
          </BottomTabItem>
          <BottomTabItem
            onClick={() => handleNavigation("/finance", "finance")}
            active={
              location.pathname === "/finance" || (location.pathname === "/auth-redirect" && tabSelected === "finance")
            }
            icon={
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  fillRule="evenodd"
                  clipRule="evenodd"
                  d="M6.5 0C4.89597 0 3.4 0.234781 2.26917 0.645993C1.70787 0.850103 1.18326 1.11678 0.780294 1.46322C0.380571 1.80688 0 2.32275 0 3V15C0 15.559 0.262564 16.0132 0.575513 16.3425C0.88373 16.6668 1.28439 16.9205 1.70615 17.1203C2.55266 17.5214 3.67269 17.7935 4.89769 17.9195C5.44708 17.976 5.93825 17.5764 5.99475 17.027C6.05126 16.4776 5.6517 15.9865 5.10231 15.93C4.0188 15.8185 3.13884 15.586 2.56247 15.3129C2.2728 15.1757 2.1063 15.05 2.02522 14.9647C2.01444 14.9533 2.0062 14.9439 2 14.9363V13.2499C2.80433 13.5804 3.80961 13.8076 4.89769 13.9195C5.44708 13.976 5.93825 13.5764 5.99475 13.027C6.05126 12.4776 5.6517 11.9865 5.10231 11.93C4.0188 11.8185 3.13884 11.586 2.56247 11.3129C2.2728 11.1757 2.1063 11.05 2.02522 10.9647C2.01444 10.9533 2.0062 10.9439 2 10.9363V9.24996C2.08852 9.28633 2.17837 9.32099 2.26917 9.35401C3.4 9.76522 4.89597 10 6.5 10C8.10403 10 9.6 9.76522 10.7308 9.35401C11.2921 9.1499 11.8167 8.88322 12.2197 8.53678C12.6194 8.19312 13 7.67725 13 7V3C13 2.32275 12.6194 1.80688 12.2197 1.46322C11.8167 1.11678 11.2921 0.850103 10.7308 0.645993C9.6 0.234781 8.10403 0 6.5 0ZM2.08414 2.97979C2.07591 2.98687 2.06831 2.99361 2.06129 3C2.06831 3.00639 2.07591 3.01313 2.08414 3.02021C2.2378 3.15231 2.51866 3.3166 2.95266 3.47442C3.81243 3.78707 5.06647 4 6.5 4C7.93353 4 9.18757 3.78707 10.0473 3.47442C10.4813 3.3166 10.7622 3.15231 10.9159 3.02021C10.9241 3.01313 10.9317 3.00639 10.9387 3C10.9317 2.99361 10.9241 2.98687 10.9159 2.97979C10.7622 2.84769 10.4813 2.6834 10.0473 2.52558C9.18757 2.21293 7.93353 2 6.5 2C5.06647 2 3.81243 2.21293 2.95266 2.52558C2.51866 2.6834 2.2378 2.84769 2.08414 2.97979ZM11 5.24996V6.93678C10.9854 6.95479 10.9595 6.98268 10.9159 7.02021C10.7622 7.15231 10.4813 7.3166 10.0473 7.47442C9.18757 7.78707 7.93353 8 6.5 8C5.06647 8 3.81243 7.78707 2.95266 7.47442C2.51866 7.3166 2.2378 7.15231 2.08414 7.02021C2.04049 6.98268 2.01461 6.95479 2 6.93678V5.24996C2.08852 5.28633 2.17837 5.32099 2.26917 5.35401C3.4 5.76522 4.89597 6 6.5 6C8.10403 6 9.6 5.76522 10.7308 5.35401C10.8216 5.32099 10.9115 5.28633 11 5.24996Z"
                  fill="currentColor"
                />
                <path
                  fillRule="evenodd"
                  clipRule="evenodd"
                  d="M7.78029 11.4632C7.38057 11.8069 7 12.3228 7 13V17C7 17.6772 7.38057 18.1931 7.78029 18.5368C8.18326 18.8832 8.70787 19.1499 9.26917 19.354C10.4 19.7652 11.896 20 13.5 20C15.104 20 16.6 19.7652 17.7308 19.354C18.2921 19.1499 18.8167 18.8832 19.2197 18.5368C19.6194 18.1931 20 17.6772 20 17V13C20 12.3228 19.6194 11.8069 19.2197 11.4632C18.8167 11.1168 18.2921 10.8501 17.7308 10.646C16.6 10.2348 15.104 10 13.5 10C11.896 10 10.4 10.2348 9.26917 10.646C8.70787 10.8501 8.18326 11.1168 7.78029 11.4632ZM18 16.9368V15.25C17.9115 15.2863 17.8216 15.321 17.7308 15.354C16.6 15.7652 15.104 16 13.5 16C11.896 16 10.4 15.7652 9.26917 15.354C9.17837 15.321 9.08852 15.2863 9 15.25V16.9368C9.01461 16.9548 9.04049 16.9827 9.08414 17.0202C9.2378 17.1523 9.51865 17.3166 9.95266 17.4744C10.8124 17.7871 12.0665 18 13.5 18C14.9335 18 16.1876 17.7871 17.0473 17.4744C17.4813 17.3166 17.7622 17.1523 17.9159 17.0202C17.9595 16.9827 17.9854 16.9548 18 16.9368ZM9.06129 13C9.06831 12.9936 9.07591 12.9869 9.08414 12.9798C9.2378 12.8477 9.51865 12.6834 9.95266 12.5256C10.8124 12.2129 12.0665 12 13.5 12C14.9335 12 16.1876 12.2129 17.0473 12.5256C17.4813 12.6834 17.7622 12.8477 17.9159 12.9798L17.9275 12.9899L17.9387 13C17.9317 13.0064 17.9241 13.0131 17.9159 13.0202C17.7622 13.1523 17.4813 13.3166 17.0473 13.4744C16.1876 13.7871 14.9335 14 13.5 14C12.0665 14 10.8124 13.7871 9.95266 13.4744C9.51865 13.3166 9.2378 13.1523 9.08414 13.0202C9.07591 13.0131 9.06831 13.0064 9.06129 13Z"
                  fill="currentColor"
                />
              </svg>
            }
          >
            {t("finance", { defaultValue: "Finance" })}
          </BottomTabItem>
          <BottomTabItem
            onClick={() => handleNavigation("/products", "products")}
            active={
              location.pathname === "/products" ||
              (location.pathname === "/auth-redirect" && tabSelected === "products")
            }
            icon={
              <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M10.577 0.323977C10.8611 0.272969 11.139 0.272969 11.423 0.323977C11.7059 0.374797 11.9356 0.45603 12.3944 0.664597L19.7496 4.00784C20.2011 4.21309 20.4283 4.35373 20.6535 4.57331C20.8754 4.78962 21.0399 5.04505 21.145 5.33658C21.2517 5.63251 21.2857 5.89749 21.2857 6.3935V15.2654C21.2857 15.7614 21.2517 16.0264 21.145 16.3223C21.0399 16.6138 20.8754 16.8693 20.6535 17.0856C20.4283 17.3052 20.2011 17.4458 19.7496 17.6511L12.2326 21.0667C11.8773 21.2227 11.6706 21.2904 11.423 21.3349C11.139 21.3859 10.8611 21.3859 10.577 21.3349C10.2941 21.2841 10.0644 21.2029 9.60559 20.9943L2.25045 17.6511C1.7989 17.4458 1.57176 17.3052 1.3465 17.0856C1.12459 16.8693 0.960114 16.6138 0.855021 16.3223C0.74834 16.0264 0.714294 15.7614 0.714294 15.2654L0.715966 6.21781C0.723941 5.83076 0.761675 5.59552 0.855021 5.33658C0.960114 5.04505 1.12459 4.78962 1.3465 4.57331C1.57176 4.35373 1.7989 4.21309 2.25045 4.00784L9.76746 0.592164C10.1227 0.436197 10.3295 0.368444 10.577 0.323977ZM2.42858 6.58915L2.42895 15.3588C2.43044 15.5308 2.43658 15.6163 2.44948 15.6773L2.46772 15.741C2.48481 15.7884 2.50701 15.8228 2.54309 15.858C2.60377 15.9172 2.67316 15.9601 2.95983 16.0904L10.1429 19.3554L10.1428 10.085C10.1308 10.0808 10.1189 10.0764 10.1069 10.072L9.93595 10.0016L2.42858 6.58915ZM19.5714 6.58829L12.0641 10.0016C11.9964 10.0324 11.9276 10.0601 11.8581 10.0847L11.8572 19.3554L19.0402 16.0904C19.2245 16.0067 19.319 15.959 19.3791 15.9199L19.4065 15.901L19.4569 15.858C19.493 15.8228 19.5152 15.7884 19.5323 15.741C19.561 15.6612 19.5714 15.5803 19.5714 15.2654V6.58829ZM6.28572 4.05629L3.64229 5.25801L10.6453 8.44097C10.8385 8.52878 11.0561 8.54132 11.2563 8.4786L11.3547 8.44097L13.6426 7.40086L6.28572 4.05629ZM11.1199 2.01127C11.0363 1.99625 10.9637 1.99625 10.8801 2.01127C10.7637 2.03216 10.6554 2.07049 10.315 2.22522L8.35658 3.11429L15.7143 6.45886L18.3569 5.25801L11.6851 2.22522C11.4581 2.12207 11.3343 2.07065 11.2425 2.04164L11.199 2.02887L11.1199 2.01127Z"
                  fill="currentColor"
                />
              </svg>
            }
          >
            {t("product", {
              defaultValue:
                accessTokenExist && businessTypeName !== "" && businessTypeName !== "Supplier" ? "Menu" : "Product",
            })}
          </BottomTabItem>
          <BottomTabItem
            active={
              location.pathname === "/pos-calculator" ||
              (location.pathname === "/auth-redirect" && tabSelected === "pos")
            }
            onClick={() => handleNavigation("/pos-calculator", "pos")}
            icon={
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path
                  d="M6.5 11C7.88071 11 9 12.1193 9 13.5V17.5C9 18.8807 7.88071 20 6.5 20H2.5C1.11929 20 0 18.8807 0 17.5V13.5C0 12.1193 1.11929 11 2.5 11H6.5ZM19 17C19.2761 17 19.5 17.2239 19.5 17.5V19C19.5 19.2761 19.2761 19.5 19 19.5H17.5C17.2239 19.5 17 19.2761 17 19V17.5C17 17.2239 17.2239 17 17.5 17H19ZM13.5 17C13.7761 17 14 17.2239 14 17.5V19C14 19.2761 13.7761 19.5 13.5 19.5H12C11.7239 19.5 11.5 19.2761 11.5 19V17.5C11.5 17.2239 11.7239 17 12 17H13.5ZM6.25 12.75H2.75C2.19772 12.75 1.75 13.1977 1.75 13.75V17.25C1.75 17.8023 2.19772 18.25 2.75 18.25H6.25C6.80228 18.25 7.25 17.8023 7.25 17.25V13.75C7.25 13.1977 6.80228 12.75 6.25 12.75ZM16.25 14.25C16.5261 14.25 16.75 14.4739 16.75 14.75V16.25C16.75 16.5261 16.5261 16.75 16.25 16.75H14.75C14.4739 16.75 14.25 16.5261 14.25 16.25V14.75C14.25 14.4739 14.4739 14.25 14.75 14.25H16.25ZM5.25 14.25C5.52614 14.25 5.75 14.4739 5.75 14.75V16.25C5.75 16.5261 5.52614 16.75 5.25 16.75H3.75C3.47386 16.75 3.25 16.5261 3.25 16.25V14.75C3.25 14.4739 3.47386 14.25 3.75 14.25H5.25ZM19 11.5C19.2761 11.5 19.5 11.7239 19.5 12V13.5C19.5 13.7761 19.2761 14 19 14H17.5C17.2239 14 17 13.7761 17 13.5V12C17 11.7239 17.2239 11.5 17.5 11.5H19ZM13.5 11.5C13.7761 11.5 14 11.7239 14 12V13.5C14 13.7761 13.7761 14 13.5 14H12C11.7239 14 11.5 13.7761 11.5 13.5V12C11.5 11.7239 11.7239 11.5 12 11.5H13.5ZM17.5 0C18.8807 0 20 1.11929 20 2.5V6.5C20 7.88071 18.8807 9 17.5 9H13.5C12.1193 9 11 7.88071 11 6.5V2.5C11 1.11929 12.1193 0 13.5 0H17.5ZM6.5 0C7.88071 0 9 1.11929 9 2.5V6.5C9 7.88071 7.88071 9 6.5 9H2.5C1.11929 9 0 7.88071 0 6.5V2.5C0 1.11929 1.11929 0 2.5 0H6.5ZM17.25 1.75H13.75C13.1977 1.75 12.75 2.19772 12.75 2.75V6.25C12.75 6.80228 13.1977 7.25 13.75 7.25H17.25C17.8023 7.25 18.25 6.80228 18.25 6.25V2.75C18.25 2.19772 17.8023 1.75 17.25 1.75ZM6.25 1.75H2.75C2.19772 1.75 1.75 2.19772 1.75 2.75V6.25C1.75 6.80228 2.19772 7.25 2.75 7.25H6.25C6.80228 7.25 7.25 6.80228 7.25 6.25V2.75C7.25 2.19772 6.80228 1.75 6.25 1.75ZM16.25 3.25C16.5261 3.25 16.75 3.47386 16.75 3.75V5.25C16.75 5.52614 16.5261 5.75 16.25 5.75H14.75C14.4739 5.75 14.25 5.52614 14.25 5.25V3.75C14.25 3.47386 14.4739 3.25 14.75 3.25H16.25ZM5.25 3.25C5.52614 3.25 5.75 3.47386 5.75 3.75V5.25C5.75 5.52614 5.52614 5.75 5.25 5.75H3.75C3.47386 5.75 3.25 5.52614 3.25 5.25V3.75C3.25 3.47386 3.47386 3.25 3.75 3.25H5.25Z"
                  fill="currentColor"
                />
              </svg>
            }
          >
            {t("pos", { defaultValue: "POS" })}
          </BottomTabItem>
          <BottomTabItem
            onClick={() => handleNavigation("/profile", "profile")}
            active={
              location.pathname === "/profile" || (location.pathname === "/auth-redirect" && tabSelected === "profile")
            }
            icon={
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="12" cy="12" r="10" fill="currentColor" />
              </svg>
            }
          >
            {t("profile", { defaultValue: "Profile" })}
          </BottomTabItem>
        </div>
      }
      contentClassName="h-full"
    >
      {props.children}
    </ActivityLayout>
  );
};
